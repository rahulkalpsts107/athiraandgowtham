<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athira & Gowtham's Wedding Invitation</title>
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://athiraandgowtham.onrender.com/">
    <meta property="og:title" content="Athira & Gowtham's Wedding Invitation">
    <meta property="og:description" content="You are cordially invited to celebrate our wedding on August 21, 2025 in Bengaluru">
    <meta property="og:image" content="https://res.cloudinary.com/dl4p1qeva/image/upload/v1747936598/ba497ebf-bee7-4849-831b-e00ec76173b2_qo1oyc.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- WhatsApp specific -->
    <meta property="og:image:secure_url" content="https://res.cloudinary.com/dl4p1qeva/image/upload/v1747936598/ba497ebf-bee7-4849-831b-e00ec76173b2_qo1oyc.jpg">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=<%- process.env.GOOGLE_ANALYTICS_ID %>"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '<%- process.env.GOOGLE_ANALYTICS_ID %>', {
            page_title: 'Wedding Invitation',
            page_location: window.location.href,
            page_path: window.location.pathname
        });
    </script>
    
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Gilda+Display&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Abhaya+Libre:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="top-header">
                <div class="hamburger-menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="small-brand" onclick="showSection('home'); return false;" style="cursor: pointer;">a & g</div>
            </div>
            <h1 class="couple-name">Athira & Gowtham</h1>
            <div class="wedding-details">
                <p class="date-location">Thursday, August 21, 2025 • Bengaluru, Karnataka, India</p>
                <p id="countdown" class="countdown-text"></p>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li><a href="#" onclick="showSection('home'); return false;">Home</a></li>
                    <li><a href="#" onclick="showSection('invite-image'); return false;">View Invitation</a></li>
                    <li><a href="#" onclick="showSection('story'); return false;">Our Story</a></li>
                    <li><a href="#" onclick="showSection('location'); return false;">Location</a></li>
                    <li><a href="#" onclick="showSection('rsvp'); return false;">RSVP</a></li>
                    <li><a href="#" onclick="showSection('livestream'); return false;">Live Stream</a></li>
                    <li><a href="#" onclick="showSection('photos'); return false;">Photos</a></li>
                    <li><a href="#" onclick="showSection('share'); return false;">Share Photos</a></li>
                </ul>
            </nav>
        </header>

        <div id="home" class="section">
            <p class="welcome-text">Welcome!</p>
            <p class="welcome-text-msg">We are thrilled to invite you to our wedding celebration. Join us on this occasion for a day of love, laughter, and celebration!</p>
            <div class="family-photo">
                <img src="https://res.cloudinary.com/dl4p1qeva/image/upload/v1747903830/family-pic_et4r6x.jpg" alt="Family Photo">
            </div>
            <div class="days-to-go">
                <p id="countdown"></p>
            </div>
        </div>

        <div id="invite-image" class="section hidden">
            <div class="invitation-video-container">
                <iframe 
                    width="100%" 
                    height="800" 
                    src="https://www.youtube.com/embed/xXNUHY5jMPU?autoplay=1&mute=1&playsinline=1&controls=1&loop=1&playlist=xXNUHY5jMPU&rel=0&modestbranding=1&enablejsapi=1" 
                    title="Wedding Invitation" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen
                    id="invitationVideo">
                </iframe>
            </div>
        </div>

        <div id="story" class="section hidden">
            <div class="story-container">
                <div class="about-person">
                    <h3>Athira Revi</h3>
                    <p>Athira is a dynamic and innovative Product Owner with a passion for bringing creativity into every aspect of her work. Originally from Kerala, her journey has been shaped by diverse experiences in both technology and life. Outside of work, Athira expresses her artistic side through drawing and painting, and she brings the same energy to her social life—always ready for new adventures, including her love for ice skating.</p>
                </div>
                <div class="about-person">
                    <h3>Gowtham Vijaykumar</h3>
                    <p>Gowtham is a dedicated finance professional with a strong passion for technology and a knack for problem-solving. His sharp analytical skills, paired with a warm and approachable personality, create a well-rounded presence. A true sports enthusiast, Gowtham is an avid football fan and proudly supports Manchester United.</p>
                </div>
                <div class="our-story">
                    <h3>Our Story</h3>
                    <p>Brought together by destiny and bonded over a shared love for technology, travel, and food, our journey began as friends and gradually blossomed into a lifelong partnership. Along the way, we've created unforgettable memories, shared endless laughter, and watched our love deepen with every experience we’ve shared.</p>
                </div>
            </div>
        </div>

        <div id="location" class="section hidden">
            <div class="location-container">
                <div class="location-details">
                    <h2>Wedding Venue Address</h2>
                    <p>Vila Kasu</p>
                    <p></p>1, Kariyammana Agrahara Rd, Yemalur, Post 560037</p>
                    <p>Bengaluru</p>
                    <button onclick="getDirections()" class="map-button">Get Directions</button>
                </div>
                <div class="map-container">
                    <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d497.06334761916324!2d77.68109909325422!3d12.943319832193993!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zMTLCsDU2JzM2LjQiTiA3N8KwNDAnNTEuOSJF!5e0!3m2!1sen!2sin!4v1629789012345!5m2!1sen!2sin" allowfullscreen></iframe>
                </div>
            </div>
        </div>

        <div id="rsvp" class="section hidden">
            <h2>RSVP</h2>
            <form id="rsvpForm" class="rsvp-form">
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" required>
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>
                <label for="attending">Will you attend the sangeet?</label>
                <select id="attending" name="attending">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
                <button type="submit">Submit RSVP</button>
                <div id="rsvpStatus"></div>
            </form>
        </div>

        <div id="livestream" class="section hidden">
            <div class="livestream-container">
                <h2>Watching Wedding Live</h2>
                <div class="video-container">
                    <iframe 
                        width="853" 
                        height="480" 
                        src="https://www.youtube.com/embed/6rVi9NBLpEc?autoplay=1&live=1" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                </div>
                <p class="stream-note">Join us virtually for our special day!</p>
            </div>
        </div>

        <div id="photos" class="section hidden">
            <div class="slideshow-container">
                <div id="slides-container">
                    <!-- Slides will be inserted here dynamically -->
                </div>
                <a class="prev" onclick="changeSlide(-1)">&#10094;</a>
                <a class="next" onclick="changeSlide(1)">&#10095;</a>
            </div>
            <div id="dots-container" class="dot-container">
                <!-- Dots will be inserted here dynamically -->
            </div>
        </div>

        <div id="share" class="section hidden">
            <div class="upload-section">
                <h3>Share Your Photos!</h3>
                <form id="uploadForm" class="upload-form" enctype="multipart/form-data">
                    <input type="file" name="photo" accept="image/*" required>
                    <button type="submit">Upload Photo</button>
                    <div id="uploadStatus"></div>
                </form>
            </div>
            <div class="shared-photos-grid"></div>
            <div id="loading-spinner" class="loading-spinner hidden">Loading more photos...</div>
        </div>

        <div class="contact-popup" id="contactPopup">
            <div class="popup-content">
                <span class="close-popup">&times;</span>
                <h3>Contact Us</h3>
                <p class="contact-intro">We'd love to hear from you! Share your kind words, feedback, or reach out if you need any information about our website.</p>
                <form id="contactForm">
                    <input type="text" name="name" placeholder="Your Name" required>
                    <input type="email" name="email" placeholder="Your Email" required>
                    <textarea name="message" placeholder="Your message, wishes, or questions..." required></textarea>
                    <button type="submit">Send Message</button>
                    <div id="contactStatus"></div>
                </form>
            </div>
        </div>
        <button id="contactButton" class="contact-button">Contact Us</button>
        <footer class="footer">
            <div class="brand">A & G</div>
            <div class="footer-separator"></div>
            <div class="date">21.08.2025</div>
            <div class="copyright">© Anvi Corp 2025</div>
        </footer>
    </div>
    <script>
        // YouTube player control
        let youtubePlayer;
        
        // This function will be called by YouTube API when ready
        function onYouTubeIframeAPIReady() {
            console.log('YouTube API Ready');
        }
        
        // Document ready event for YouTube video
        document.addEventListener('DOMContentLoaded', function() {
            // When the invite-image section becomes visible
            document.querySelectorAll('nav a').forEach(link => {
                link.addEventListener('click', function() {
                    if (this.getAttribute('onclick') && this.getAttribute('onclick').includes('invite-image')) {
                        setTimeout(() => {
                            initializeYouTubePlayer();
                        }, 500);
                    }
                });
            });
        });
        
        // Initialize the player when section becomes visible
        function initializeYouTubePlayer() {
            if (youtubePlayer) {
                youtubePlayer.playVideo();
                youtubePlayer.unMute();
                youtubePlayer.setVolume(100);
                return;
            }
            
            youtubePlayer = new YT.Player('invitationVideo', {
                events: {
                    'onReady': function(event) {
                        event.target.playVideo();
                        
                        // Unmute immediately and also after delays to handle different mobile browsers
                        event.target.unMute();
                        event.target.setVolume(100);
                        
                        // Try multiple times with increasing delays for mobile browsers
                        setTimeout(() => {
                            event.target.unMute();
                            event.target.setVolume(100);
                        }, 1000);
                        
                        setTimeout(() => {
                            event.target.unMute();
                            event.target.setVolume(100);
                        }, 3000);
                    },
                    'onStateChange': function(event) {
                        // If video is playing, ensure it's unmuted
                        if (event.data === YT.PlayerState.PLAYING) {
                            event.target.unMute();
                            event.target.setVolume(100);
                        }
                        // If video ends, replay it (for looping)
                        if (event.data === YT.PlayerState.ENDED) {
                            event.target.playVideo();
                        }
                    }
                }
            });
        }
        
        // Handle direct loading of invitation section
        const urlParams = new URLSearchParams(window.location.search);
        const section = urlParams.get('section');
        if (section === 'invite-image') {
            // Initialize player when directly loading the invitation page
            setTimeout(initializeYouTubePlayer, 1000);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const hamburger = document.querySelector('.hamburger-menu');
            const navMenu = document.querySelector('.nav-menu');
            
            hamburger.addEventListener('click', (e) => {
                e.stopPropagation();
                hamburger.classList.toggle('active');
                navMenu.classList.toggle('active');
            });

            // Close menu when clicking a link
            document.querySelectorAll('nav a').forEach(link => {
                link.addEventListener('click', () => {
                    hamburger.classList.remove('active');
                    navMenu.classList.remove('active');
                });
            });

            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('nav')) {
                    hamburger.classList.remove('active');
                    navMenu.classList.remove('active');
                }
            });

            // Existing URL params code
            const urlParams = new URLSearchParams(window.location.search);
            const section = urlParams.get('section');
            if (section) {
                showSection(section);
                setActiveLink(section);
            } else {
                showSection('home');
                setActiveLink('home');
            }
        });

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            
            // Stop YouTube video if leaving the invitation section
            if (sectionId !== 'invite-image' && youtubePlayer) {
                youtubePlayer.stopVideo();
            }
            
            // Enhanced Google Analytics tracking
            gtag('event', 'page_view', {
                page_title: `${sectionId} - Wedding Invitation`,
                page_location: window.location.href,
                page_path: `/${sectionId}`
            });
            
            gtag('event', 'view_section', {
                event_category: 'Section Navigation',
                event_label: sectionId,
                value: 1
            });

            // Update URL without page reload
            const url = new URL(window.location);
            url.searchParams.set('section', sectionId);
            window.history.pushState({}, '', url);
            
            // Update active link and close mobile menu
            setActiveLink(sectionId);
            const hamburger = document.querySelector('.hamburger-menu');
            const navMenu = document.querySelector('.nav-menu');
            if (hamburger && navMenu) {
                hamburger.classList.remove('active');
                navMenu.classList.remove('active');
            }
            
            if (sectionId === 'share') {
                loadSharedPhotos();
            } else if (sectionId === 'photos') {
                loadOurPhotos();
            }
        }

        function getSectionTitle(sectionId) {
            switch(sectionId) {
                case 'home': return 'Home';
                case 'invite-image': return 'View Invitation';
                case 'story': return 'Our Story';
                case 'location': return 'Location';
                case 'rsvp': return 'RSVP';
                case 'livestream': return 'Live Stream';
                case 'photos': return 'Photos';
                case 'share': return 'Share Photos';
                default: return 'Unknown Section';
            }
        }

        function setActiveLink(sectionId) {
            // Remove active class from all links
            document.querySelectorAll('nav a').forEach(link => {
                link.classList.remove('active');
            });
            // Add active class to current section link
            const activeLink = document.querySelector(`nav a[onclick*="${sectionId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        // Existing countdown code
        const weddingDate = new Date('2025-08-21T00:00:00');
        const countdownElement = document.getElementById('countdown');

        function updateCountdown() {
            const now = new Date();
            const timeLeft = weddingDate - now;

            if (timeLeft <= 0) {
                document.getElementById('countdown').textContent = "The Big Day is Here!";
                clearInterval(timerInterval);
                return;
            }

            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            document.getElementById('countdown').textContent = `${days} DAYS TO GO!`;
        }

        const timerInterval = setInterval(updateCountdown, 1000);
        updateCountdown();

        // Remove unused photos-related functions
        let slideIndex = 1;
        showSlides(slideIndex);

        function changeSlide(n) {
            showSlides(slideIndex += n);
        }

        function currentSlide(n) {
            showSlides(slideIndex = n);
        }

        function showSlides(n) {
            let slides = document.getElementsByClassName("slide");
            let dots = document.getElementsByClassName("dot");
            
            if (!slides.length || !dots.length) {
                return;
            }
            
            if (n > slides.length) {slideIndex = 1}
            if (n < 1) {slideIndex = slides.length}
            
            for (let i = 0; i < slides.length; i++) {
                slides[i].style.display = "none";
            }
            for (let i = 0; i < dots.length; i++) {
                dots[i].className = dots[i].className.replace(" active", "");
            }
            
            slides[slideIndex-1].style.display = "block";
            dots[slideIndex-1].className += " active";
        }

        let isLoading = false;
        let hasMore = true;
        let currentPage = 1;

        async function loadSharedPhotos(page = 1, append = false) {
            if (isLoading || (!append && !hasMore)) return;
            
            try {
                isLoading = true;
                document.getElementById('loading-spinner').classList.remove('hidden');
                
                const response = await fetch(`/get-shared-photos?page=${page}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch photos');
                }
                const data = await response.json();
                
                const gridContainer = document.querySelector('.shared-photos-grid');
                if (!data.photos || data.photos.length === 0) {
                    if (!append) {
                        gridContainer.innerHTML = '<p>No photos shared yet</p>';
                    }
                    hasMore = false;
                    return;
                }

                const photoHtml = data.photos
                    .map(photoUrl => {
                        const optimizedUrl = photoUrl.replace('/upload/', '/upload/w_400,c_scale,f_auto,q_auto/');
                        return `
                            <div class="shared-photo loading">
                                <img src="${optimizedUrl}" 
                                    alt="Shared photo" 
                                    loading="lazy"
                                    decoding="async"
                                    onload="this.parentElement.classList.remove('loading')"
                                    onerror="this.parentElement.classList.add('error')">
                            </div>
                        `;
                    }).join('');

                if (append) {
                    gridContainer.insertAdjacentHTML('beforeend', photoHtml);
                } else {
                    gridContainer.innerHTML = photoHtml;
                }

                hasMore = data.hasMore;
                currentPage = data.currentPage;
            } catch (error) {
                console.error('Error loading shared photos:', error);
                if (!append) {
                    document.querySelector('.shared-photos-grid').innerHTML = 
                        '<p>Error loading photos. Please try again later.</p>';
                }
            } finally {
                isLoading = false;
                document.getElementById('loading-spinner').classList.add('hidden');
            }
        }

        // Initialize intersection observer for infinite scroll
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && hasMore && !isLoading) {
                    loadSharedPhotos(currentPage + 1, true);
                }
            });
        }, { threshold: 0.5 });

        // Observe the loading spinner
        document.addEventListener('DOMContentLoaded', () => {
            const spinner = document.getElementById('loading-spinner');
            if (spinner) {
                observer.observe(spinner);
            }
        });

        async function loadOurPhotos() {
            try {
                const slidesContainer = document.getElementById('slides-container');
                slidesContainer.innerHTML = '<div class="loading-message">Loading photos...</div>';
                
                const response = await fetch('/get-our-photos');
                if (!response.ok) {
                    throw new Error('Failed to fetch photos');
                }
                const photos = await response.json();
                
                if (!photos || photos.length === 0) {
                    slidesContainer.innerHTML = '<p>No photos available</p>';
                    return;
                }

                const photoHtml = photos
                    .map((photoUrl, index) => {
                        const optimizedUrl = photoUrl.replace('/upload/', '/upload/w_800,c_scale,f_auto,q_auto/');
                        return `
                            <div class="slide fade loading">
                                <img src="${optimizedUrl}" 
                                    alt="Our photo ${index + 1}"
                                    loading="lazy"
                                    decoding="async"
                                    onload="this.parentElement.classList.remove('loading')"
                                    onerror="this.parentElement.classList.add('error')">
                            </div>
                        `;
                    }).join('');

                slidesContainer.innerHTML = photoHtml;
                
                const dotsContainer = document.getElementById('dots-container');
                dotsContainer.innerHTML = photos
                    .map((_, index) => `
                        <span class="dot" onclick="currentSlide(${index + 1})"></span>
                    `).join('');

                showSlides(1);
            } catch (error) {
                console.error('Error loading our photos:', error);
                document.getElementById('slides-container').innerHTML = 
                    '<p>Error loading photos. Please try again later.</p>';
            }
        }

        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const statusDiv = document.getElementById('uploadStatus');
            
            try {
                statusDiv.textContent = 'Uploading...';
                const response = await fetch('/upload-photo', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (result.success) {
                    statusDiv.textContent = 'Upload successful!';
                    this.reset();
                    
                    // Add the new photo to the grid immediately
                    const gridContainer = document.querySelector('.shared-photos-grid');
                    const optimizedUrl = result.url.replace('/upload/', '/upload/w_400,f_auto,q_auto/');
                    const newPhotoHtml = `
                        <div class="shared-photo loading">
                            <img src="${optimizedUrl}" 
                                alt="Shared photo" 
                                loading="lazy"
                                onload="this.parentElement.classList.remove('loading')">
                        </div>
                    `;
                    
                    // Insert at the beginning of the grid
                    if (gridContainer.firstChild) {
                        gridContainer.insertAdjacentHTML('afterbegin', newPhotoHtml);
                    } else {
                        gridContainer.innerHTML = newPhotoHtml;
                    }
                } else {
                    statusDiv.textContent = result.message || 'Upload failed';
                }
            } catch (error) {
                console.error('Error uploading photo:', error);
                statusDiv.textContent = 'Upload failed. Please try again.';
            }
        });

        document.getElementById('rsvpForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const statusDiv = document.getElementById('rsvpStatus');
            const formData = new FormData(this);
            
            try {
                statusDiv.textContent = 'Sending RSVP...';
                const response = await fetch('/submit-rsvp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(formData)
                });
                
                const result = await response.json();
                if (result.success) {
                    statusDiv.textContent = 'Thank you! Your RSVP has been sent.';
                    this.reset();
                } else {
                    statusDiv.textContent = result.message || 'Failed to send RSVP';
                }
            } catch (error) {
                console.error('Error:', error);
                statusDiv.textContent = 'Failed to send RSVP. Please try again.';
            }
        });

        // Contact form submission
        document.getElementById('contactForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const statusDiv = document.getElementById('contactStatus');
            const formData = new FormData(this);
            
            try {
                statusDiv.textContent = 'Sending message...';
                const response = await fetch('/submit-contact', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(formData)
                });
                
                const result = await response.json();
                if (result.success) {
                    statusDiv.textContent = 'Thank you! Your message has been sent.';
                    this.reset();
                } else {
                    statusDiv.textContent = result.message || 'Failed to send message';
                }
            } catch (error) {
                console.error('Error:', error);
                statusDiv.textContent = 'Failed to send message. Please try again.';
            }
        });

        document.getElementById('contactButton').addEventListener('click', function() {
            document.getElementById('contactPopup').classList.add('active');
        });

        document.querySelector('.close-popup').addEventListener('click', function() {
            document.getElementById('contactPopup').classList.remove('active');
        });

        function getDirections() {
            const destination = '12.943319832193993,77.68109909325422';
            const mapUrl = `https://www.google.com/maps/dir/?api=1&destination=${destination}`;
            window.open(mapUrl, '_blank');
        }
    </script>
</body>
</html>