<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Athira & Gowtham's Wedding Invitation</title>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://athiraandgowtham.onrender.com/" />
    <meta property="og:title" content="Athira & Gowtham's Wedding Invitation" />
    <meta
      property="og:description"
      content="You are cordially invited to celebrate our wedding on August 21, 2025 in Bengaluru"
    />
    <meta
      property="og:image"
      content="https://res.cloudinary.com/dl4p1qeva/image/upload/v1749017407/PHOTO-2025-06-04-11-34-28_wrfsik.jpg"
    />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <!-- WhatsApp specific -->
    <meta
      property="og:image:secure_url"
      content="https://res.cloudinary.com/dl4p1qeva/image/upload/v1749017407/PHOTO-2025-06-04-11-34-28_wrfsik.jpg"
    />

    <!-- Google Analytics -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=<%- process.env.GOOGLE_ANALYTICS_ID %>"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', '<%- process.env.GOOGLE_ANALYTICS_ID %>', {
        page_title: 'Wedding Invitation',
        page_location: window.location.href,
        page_path: window.location.pathname,
      });
    </script>

    <!-- Sentry Error Tracking -->
    <script src="https://browser.sentry-cdn.com/7.101.1/bundle.min.js"></script>
    <script>
      Sentry.init({
        dsn: '<%- process.env.SENTRY_DSN %>', // Make sure to add SENTRY_DSN to your environment variables
        integrations: [new Sentry.BrowserTracing(), new Sentry.Replay()],
        tracesSampleRate: 1.0,
        replaysSessionSampleRate: 0.1,
        replaysOnErrorSampleRate: 1.0,
      });
    </script>

    <!-- Eruda for mobile debugging (temporary) -->
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>

    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Gilda+Display&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Abhaya+Libre:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="top-header">
          <div class="hamburger-menu">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <div
            class="small-brand"
            onclick="showSection('home'); return false;"
            style="cursor: pointer"
          >
            a & g
          </div>
        </div>
        <h1 class="couple-name">Athira & Gowtham</h1>
        <div class="wedding-details">
          <p class="date-location">
            Thursday, August 21, 2025 • Bengaluru, Karnataka, India
          </p>
          <p id="countdown" class="countdown-text"></p>
        </div>
        <nav>
          <ul class="nav-menu">
            <li>
              <a href="#" onclick="showSection('home'); return false;">Home</a>
            </li>
            <li>
              <a href="#" onclick="showSection('invite-image'); return false;"
                >View Invitation</a
              >
            </li>
            <li>
              <a href="#" onclick="showSection('story'); return false;"
                >Our Story</a
              >
            </li>
            <li>
              <a href="#" onclick="showSection('location'); return false;"
                >Location</a
              >
            </li>
            <li>
              <a href="#" onclick="showSection('rsvp'); return false;">RSVP</a>
            </li>
            <li>
              <a href="#" onclick="showSection('livestream'); return false;"
                >Live Stream</a
              >
            </li>
            <li>
              <a href="#" onclick="showSection('photos'); return false;"
                >Photos</a
              >
            </li>
            <li>
              <a href="#" onclick="showSection('share'); return false;"
                >Share Photos</a
              >
            </li>
          </ul>
        </nav>
      </header>

      <div id="home" class="section">
        <p class="welcome-text">Welcome!</p>
        <p class="welcome-text-msg">
          We are thrilled to invite you to our wedding celebration. Join us on
          this occasion for a day of love, laughter, and celebration!
        </p>
        <div class="family-photo">
          <img
            src="https://res.cloudinary.com/dl4p1qeva/image/upload/v1747922795/family-pic_et4r6x_totjjk.jpg"
            alt="Family Photo"
          />
        </div>
        <div class="days-to-go">
          <p id="countdown"></p>
        </div>
        
        <!-- Add to Calendar Button -->
        <div class="add-to-calendar-wrapper">
          <button class="add-to-calendar-btn" onclick="toggleCalendarOptions()">
            <span class="calendar-icon">📅</span>
            Add to Calendar
          </button>
          <div class="calendar-options" id="calendarOptions">
            <a href="#" class="calendar-option" data-calendar="google">Google Calendar</a>
            <a href="#" class="calendar-option" data-calendar="apple">Apple Calendar</a>
            <a href="#" class="calendar-option" data-calendar="outlook">Outlook</a>
            <a href="#" class="calendar-option" data-calendar="yahoo">Yahoo Calendar</a>
            <a href="#" class="calendar-option" data-calendar="ics">Download ICS</a>
          </div>
        </div>
      </div>

      <div id="invite-image" class="section hidden">
        <div class="invitation-video-container">
          <iframe
            width="100%"
            height="800"
            src="https://www.youtube.com/embed/jbE0tb2Kfz0?autoplay=1&mute=1&playsinline=1&controls=1&loop=1&playlist=xXNUHY5jMPU&rel=0&modestbranding=1&enablejsapi=1"
            title="Wedding Invitation"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
            id="invitationVideo"
          >
          </iframe>
        </div>
      </div>

      <div id="story" class="section hidden">
        <div class="story-container">
          <div class="about-person">
            <h3>Athira Revi</h3>
            <p>
              Athira is a dynamic and innovative Product Owner with a passion
              for bringing creativity into every aspect of her work. Originally
              from Kerala, her journey has been shaped by diverse experiences in
              both technology and life. Outside of work, Athira expresses her
              artistic side through drawing and painting, and she brings the
              same energy to her social life—always ready for new adventures,
              including her love for ice skating.
            </p>
          </div>
          <div class="about-person">
            <h3>Gowtham Vijaykumar</h3>
            <p>
              Gowtham is a dedicated finance professional with a strong passion
              for technology and a knack for problem-solving. His sharp
              analytical skills, paired with a warm and approachable
              personality, create a well-rounded presence. A true sports
              enthusiast, Gowtham is an avid football fan and proudly supports
              Manchester United.
            </p>
          </div>
          <div class="our-story">
            <h3>Our Story</h3>
            <p>
              Brought together by destiny and bonded over a shared love for
              technology, travel, and food, our journey began as friends and
              gradually blossomed into a lifelong partnership. Along the way,
              we've created unforgettable memories, shared endless laughter, and
              watched our love deepen with every experience we’ve shared.
            </p>
          </div>
        </div>
      </div>

      <div id="location" class="section hidden">
        <div class="location-container">
          <div class="location-details">
            <h2>Wedding Venue Address</h2>
            <p>Vila Kasu</p>
            <p>1, Kariyammana Agrahara Rd, Yemalur, Post 560037</p>
            <p>Bengaluru</p>
            <button onclick="getDirections()" class="map-button">
              Get Directions
            </button>
          </div>

          <div class="weather-widget">
            <h3>Weather at Vila Kasu</h3>
            <div id="weather-container">
              <div class="weather-loading">Loading weather...</div>
            </div>
          </div>

          <div class="map-container">
            <iframe
              src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d497.06334761916324!2d77.68109909325422!3d12.943319832193993!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zMTLCsDU2JzM2LjQiTiA3N8KwNDAnNTEuOSJF!5e0!3m2!1sen!2sin!4v1629789012345!5m2!1sen!2sin"
              allowfullscreen
            ></iframe>
          </div>
        </div>
      </div>

      <div id="rsvp" class="section hidden">
        <h2>RSVP</h2>
        <form id="rsvpForm" class="rsvp-form">
          <label for="name">Name:</label>
          <input type="text" id="name" name="name" required />
          <label for="email">Email:</label>
          <input type="email" id="email" name="email" required />
          <label for="attending">Will you attend the sangeet?</label>
          <select id="attending" name="attending">
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
          <button type="submit">Submit RSVP</button>
          <div id="rsvpStatus"></div>
        </form>
      </div>

      <div id="livestream" class="section hidden">
        <div class="livestream-container">
          <h2>Watching Wedding Live</h2>
          <div class="video-container">
            <iframe
              width="853"
              height="480"
              src="https://www.youtube.com/embed/6rVi9NBLpEc?autoplay=1&live=1"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
            >
            </iframe>
          </div>
          <p class="stream-note">Join us virtually for our special day!</p>
        </div>
      </div>

      <div id="photos" class="section hidden">
        <div class="slideshow-container">
          <div id="slides-container" class="slides-container">
            <!-- Photos will load here -->
          </div>
          <a class="prev" onclick="changeSlide(-1)">&#10094;</a>
          <a class="next" onclick="changeSlide(1)">&#10095;</a>
        </div>
        <div id="dots-container" class="dot-container">
          <!-- Dots will be added here -->
        </div>
      </div>

      <div id="share" class="section hidden">
        <div class="upload-section">
          <h3>Share Your Photos!</h3>
          <form
            id="uploadForm"
            class="upload-form"
            enctype="multipart/form-data"
          >
            <input type="file" name="photo" accept="image/*" required />
            <button type="submit">Upload Photo</button>
            <div id="uploadStatus"></div>
          </form>
        </div>

        <div class="instagram-hashtag-section">
          <h3>
            <span class="instagram-icon">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"
                />
              </svg>
            </span>
            Share on Instagram
          </h3>
          <div class="hashtag-display">
            <p>Use our wedding hashtag when posting photos:</p>
            <div class="hashtag-box">
              #athirawedsgowtham2025
              <button class="copy-button" onclick="copyHashtag(event)">
                Copy
              </button>
            </div>
            <p class="hashtag-subtext">
              Tag us and we'll feature our favorites!
            </p>
            <a
              href="https://instagram.com/explore/tags/athirawedsgowtham2025"
              target="_blank"
              class="instagram-link"
            >
              View all photos on Instagram →
            </a>
          </div>
        </div>

        <div class="shared-photos-section">
          <h3>📷 Photos Shared by Guests</h3>
          <div class="shared-photos-grid"></div>
        </div>
        <div id="loading-spinner" class="loading-spinner hidden">
          Loading more photos...
        </div>
      </div>

      <div class="contact-popup" id="contactPopup">
        <div class="popup-content">
          <span class="close-popup">&times;</span>
          <h3>Contact Us</h3>
          <p class="contact-intro">
            We'd love to hear from you! Share your kind words, feedback, or
            reach out if you need any information about our website.
          </p>
          <form id="contactForm">
            <input type="text" name="name" placeholder="Your Name" required />
            <input
              type="email"
              name="email"
              placeholder="Your Email"
              required
            />
            <textarea
              name="message"
              placeholder="Your message, wishes, or questions..."
              required
            ></textarea>
            <button type="submit">Send Message</button>
            <div id="contactStatus"></div>
          </form>
        </div>
      </div>
      <button id="contactButton" class="contact-button">Contact Us</button>
      <button id="muteButton" class="mute-button">
        <span class="mute-icon">🔈</span>
      </button>
      
      <!-- Unmute prompt to guide mobile users -->
      <div id="unmutePrompt" class="unmute-prompt">
        <span class="unmute-icon">🔊</span>
        <span>Tap to unmute invitation</span>
      </div>

      <!-- Lightbox for shared photos -->
      <div id="photoLightbox" class="lightbox">
        <div class="lightbox-content">
          <button class="lightbox-close">&times;</button>
          <img id="lightboxImage" src="" alt="Shared photo">
        </div>
      </div>
      
      <footer class="footer">
        <div class="brand">A & G</div>
        <div class="footer-separator"></div>
        <div class="date">21.08.2025</div>
        <div class="copyright">© Anvi Corp 2025</div>
      </footer>
    </div>
    <script>
      // YouTube player control
      let invitationPlayer;
      const isMuted = true;

      function updateMuteButton() {
        const muteButton = document.getElementById('muteButton');
        if (muteButton) {
          if (invitationPlayer) {
            muteButton.disabled = false;
            muteButton.classList.remove('disabled');
            try {
              const isMuted = invitationPlayer.isMuted();
              muteButton.querySelector('.mute-icon').textContent = isMuted
                ? '🔇'
                : '🔊';
              console.log('Mute state updated:', isMuted);
            } catch (error) {
              console.log('Player not ready yet, using fallback');
              muteButton.querySelector('.mute-icon').textContent = '🔇';
            }
          } else {
            muteButton.disabled = true;
            muteButton.classList.add('disabled');
            muteButton.querySelector('.mute-icon').textContent = '🔇';
          }
        }
      }

      function initializeYouTubePlayer() {
        if (invitationPlayer) return;

        // Replace the iframe with a div for the API
        const iframe = document.getElementById('invitationVideo');
        const playerDiv = document.createElement('div');
        playerDiv.id = 'youtube-player';
        iframe.parentNode.replaceChild(playerDiv, iframe);

        invitationPlayer = new YT.Player('youtube-player', {
          height: '800',
          width: '100%',
          videoId: 'xXNUHY5jMPU',
          playerVars: {
            autoplay: 1,
            mute: 1,
            playsinline: 1,
            controls: 1,
            loop: 1,
            playlist: 'xXNUHY5jMPU',
            rel: 0,
            modestbranding: 1,
          },
          events: {
            onReady: function (event) {
              console.log('Invitation player ready');
              event.target.playVideo();
              event.target.mute(); // Ensure video starts muted
              setTimeout(() => updateMuteButton(), 500);
              // No auto-unmute functionality
            },
            onStateChange: function (event) {
              if (event.data === YT.PlayerState.PLAYING) {
                setTimeout(() => updateMuteButton(), 100);
              } else if (event.data === YT.PlayerState.ENDED) {
                event.target.playVideo();
              }
            },
            onVolumeChange: () => updateMuteButton(),
          },
        });
      }

      document.addEventListener('DOMContentLoaded', function () {
        const muteButton = document.getElementById('muteButton');
        if (muteButton) {
          // Initialize as disabled
          updateMuteButton();

          muteButton.addEventListener('click', function () {
            if (
              invitationPlayer &&
              typeof invitationPlayer.isMuted === 'function' &&
              !muteButton.disabled
            ) {
              try {
                if (invitationPlayer.isMuted()) {
                  invitationPlayer.unMute();
                  invitationPlayer.setVolume(100);
                } else {
                  invitationPlayer.mute();
                }
                setTimeout(() => updateMuteButton(), 100);
              } catch (error) {
                console.error('Error toggling mute:', error);
              }
            }
          });
        }

        // Make the unmute prompt clickable to unmute the video
        const unmutePrompt = document.getElementById('unmutePrompt');
        if (unmutePrompt) {
          unmutePrompt.addEventListener('click', function() {
            if (invitationPlayer && 
                typeof invitationPlayer.isMuted === 'function' && 
                invitationPlayer.isMuted()) {
              
              // Unmute the video
              invitationPlayer.unMute();
              invitationPlayer.setVolume(80);
              
              // Update the mute button icon
              updateMuteButton();
              
              // Hide the prompt after unmuting
              unmutePrompt.classList.remove('visible');
              
              // Log the unmute action
              console.log('Video unmuted via prompt');
            }
          });
        }

        // Initialize if directly loading invitation section
        const urlParams = new URLSearchParams(window.location.search);
        const section = urlParams.get('section');
        if (section === 'invite-image') {
          setTimeout(initializeYouTubePlayer, 1000);
        }
      });

      // Handle direct loading of invitation section
      const urlParams = new URLSearchParams(window.location.search);
      const section = urlParams.get('section');
      if (section === 'invite-image') {
        setTimeout(initializeYouTubePlayer, 1000);
      }

      document.addEventListener('DOMContentLoaded', function () {
        const hamburger = document.querySelector('.hamburger-menu');
        const navMenu = document.querySelector('.nav-menu');

        // Handle mobile menu
        hamburger.addEventListener('click', e => {
          e.stopPropagation();
          hamburger.classList.toggle('active');
          navMenu.classList.toggle('active');
        });

        // Close menu when clicking outside
        document.addEventListener('click', e => {
          if (
            !e.target.closest('nav') &&
            !e.target.closest('.hamburger-menu')
          ) {
            hamburger.classList.remove('active');
            navMenu.classList.remove('active');
          }
        });

        // Add event listeners to nav links
        document.querySelectorAll('nav a').forEach(link => {
          link.addEventListener('click', e => {
            e.preventDefault();
            const sectionId = link
              .getAttribute('onclick')
              ?.match(/showSection\('(.+?)'\)/)?.[1];
            if (sectionId) {
              // Close mobile menu before showing section
              hamburger.classList.remove('active');
              navMenu.classList.remove('active');

              // Small delay to allow menu to close smoothly
              setTimeout(() => {
                showSection(sectionId); // Calls the now global showSection
              }, 100);
            }
          });
        });

        // Handle initial section from URL
        const urlParams = new URLSearchParams(window.location.search);
        const section = urlParams.get('section');
        if (section) {
          showSection(section); // Calls the now global showSection
        } else {
          showSection('invite-image'); // Default to invite-image
        }

        // Initialize intersection observer for infinite scroll
        const spinner = document.getElementById('loading-spinner');
        if (spinner) {
          observer.observe(spinner);
        }
      });

      // Moved showSection outside DOMContentLoaded to make it globally accessible
      function showSection(sectionId) {
        if (!sectionId) return;

        document.querySelectorAll('nav a').forEach(link => {
          const linkSectionId = link
            .getAttribute('onclick')
            ?.match(/showSection\\('(.+?)'\\)/)?.[1];
          if (linkSectionId === sectionId) {
            link.classList.add('active');
          } else {
            link.classList.remove('active');
          }
        });

        document.querySelectorAll('.section').forEach(section => {
          section.classList.add('hidden');
        });

        const selectedSection = document.getElementById(sectionId);
        if (selectedSection) {
          selectedSection.classList.remove('hidden');

          const url = new URL(window.location);
          url.searchParams.set('section', sectionId);
          window.history.pushState({ sectionId }, '', url);
          
          // Add invitation-active class to body when showing invitation
          if (sectionId === 'invite-image') {
            document.body.classList.add('invitation-active');
            
            // Show unmute prompt for all users, not just mobile
            const unmutePrompt = document.getElementById('unmutePrompt');
            
            if (unmutePrompt) {
              // Show the unmute prompt with a slight delay
              setTimeout(() => {
                unmutePrompt.classList.add('visible');
                
                // Hide the prompt after 15 seconds
                setTimeout(() => {
                  unmutePrompt.classList.remove('visible');
                }, 15000); // Changed from 6000 to 15000
              }, 2000);
            }
          } else {
            document.body.classList.remove('invitation-active');
          }

          if (sectionId === 'photos') {
            setTimeout(() => loadOurPhotos(false), 100); // CHANGED: pass false for initial load
          } else if (sectionId === 'share') {
            setTimeout(() => loadSharedPhotos(), 100);
          } else if (sectionId === 'invite-image' && !invitationPlayer) {
            setTimeout(() => initializeYouTubePlayer(), 500);
          }

          gtag('event', 'view_section', {
            event_category: 'Section Navigation',
            event_label: sectionId,
          });
        }
      }

      // Handle browser back/forward buttons
      window.addEventListener('popstate', function (event) {
        const section =
          event.state?.sectionId ||
          new URLSearchParams(window.location.search).get('section') ||
          'invite-image'; // Default to invite-image
        showSection(section); // Calls the now global showSection
      });

      // Existing countdown code
      const weddingDate = new Date('2025-08-21T00:00:00');
      const countdownElement = document.getElementById('countdown');

      function updateCountdown() {
        const now = new Date();
        const timeLeft = weddingDate - now;

        if (timeLeft <= 0) {
          document.getElementById('countdown').textContent =
            'The Big Day is Here!';
          clearInterval(timerInterval);
          return;
        }

        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        document.getElementById('countdown').textContent =
          `${days} DAYS TO GO!`;
      }

      const timerInterval = setInterval(updateCountdown, 1000);
      updateCountdown();

      // Update 'Our Photos' section to load images in batches of 5
      let slideIndex = 1;
      let allPhotos = [];
      let totalPhotos = 0; // Assuming API provides this on first load for UI consistency
      const photosPerBatch = 5;

      // Pagination variables for Our Photos
      // let ourPhotosCurrentPage = 1; // REMOVED
      let ourPhotosNextCursor = null; // ADDED for cursor-based pagination
      let ourPhotosLoading = false;
      let ourPhotosAllDataLoaded = false;

      function log(message, data = {}) {
        const timestamp = new Date().toISOString();
        console.log(
          JSON.stringify({
            timestamp,
            message,
            ...data,
          })
        );
      }

      async function loadOurPhotos(append = false) { // CHANGED SIGNATURE
        if (ourPhotosLoading || (append && ourPhotosAllDataLoaded)) return; // MODIFIED CONDITION
        ourPhotosLoading = true;

        const slidesContainer = document.getElementById('slides-container');
        try {
          if (!append) { // This is an initial load
            allPhotos = [];
            ourPhotosNextCursor = null; // Reset cursor for a fresh load
            ourPhotosAllDataLoaded = false; // Reset all data loaded flag
            slidesContainer.innerHTML =
              '<div class="loading">Loading photos...</div>';
            totalPhotos = 0; // Reset totalPhotos, will be set from API if available
          } else {
            // Optional: Show a specific loading indicator for appended batches if needed
            // For now, the main loading/slideshow update handles visual feedback.
          }

          let url = `/our-photos?limit=${photosPerBatch}`; // API endpoint
          if (append && ourPhotosNextCursor) {
            url += `&next_cursor=${encodeURIComponent(ourPhotosNextCursor)}`;
          }
          // If !append, no cursor is sent; backend should return the first set of items.

          const response = await fetch(url);
          if (!response.ok) throw new Error('Failed to fetch our photos');
          const data = await response.json(); // Expect { photos: [], next_cursor: "...", totalPhotos: "..." (optional) }

          if (!append && data.totalPhotos !== undefined) { // On initial load, if API provides totalPhotos
            totalPhotos = data.totalPhotos;
          }

          if (!data.photos || data.photos.length === 0) {
            if (!append && allPhotos.length === 0) { // No photos at all on initial load
                 slidesContainer.innerHTML = '<p>No photos available yet.</p>';
            }
            // If appending and no new photos, or initial load and no photos, mark as all loaded.
            ourPhotosAllDataLoaded = true;
            // Loading indicator removal is handled further down or by showSlides.
          } else {
            allPhotos = [...allPhotos, ...data.photos];
            // If totalPhotos wasn't provided by API, we might need to adjust UI relying on it,
            // or assume allPhotos.length is the current total for display purposes if it dynamically grows.
            // For now, assuming totalPhotos is primarily for the "X of Y" counter and dots.
            // If totalPhotos is not reliably available, the dot generation and counter might need to only reflect loaded items.
          }
          
          // Update slideshow with ALL loaded photos
          // This part of the logic (rebuilding HTML, dots, counter) can remain largely the same,
          // but ensure it uses `totalPhotos` correctly if it's available, or `allPhotos.length` if not.
          const photoHtml = allPhotos
            .map(
              (photo, index) => `
                    <div class="slide fade">
                        <img src="${photo}" alt="Our Photo ${index + 1}" loading="lazy">
                    </div>
                `
            )
            .join('');
          slidesContainer.innerHTML = photoHtml || '<p>No photos available yet.</p>'; // Ensure fallback if allPhotos is empty

          // Add or update photo counter
          let photoCounter = document.querySelector('.photo-counter');
          if (!photoCounter && totalPhotos > 0) { // Only add counter if there are photos
            photoCounter = document.createElement('div');
            photoCounter.className = 'photo-counter';
            slidesContainer.parentElement.insertBefore(
              photoCounter,
              slidesContainer
            );
          }
          if (photoCounter) {
             photoCounter.textContent = `Photo ${slideIndex} of ${totalPhotos || allPhotos.length}`;
          }

          // Update dots for all photos (if totalPhotos is known)
          const dotsContainer = document.getElementById('dots-container');
          if (totalPhotos > 0) {
            dotsContainer.innerHTML = Array(totalPhotos)
              .fill(0)
              .map(
                (_, index) => `
                      <span class="dot" onclick="currentSlide(${index + 1})"></span>
                  `
              )
              .join('');
          } else {
            dotsContainer.innerHTML = ''; // Clear dots if no totalPhotos
          }

          // Update cursor and loaded state
          ourPhotosNextCursor = data.next_cursor;
          if (!ourPhotosNextCursor) {
            ourPhotosAllDataLoaded = true;
          }

          if (allPhotos.length > 0) {
             showSlides(slideIndex); // Refresh slideshow display
          } else if (!append) {
            // If initial load resulted in no photos, and already handled by innerHTML update.
          }

          // Remove loading indicator if it exists (e.g., the initial one)
          const loadingIndicator =
            slidesContainer.querySelector('.loading'); // General loading div
          if (loadingIndicator && (allPhotos.length > 0 || ourPhotosAllDataLoaded)) {
            loadingIndicator.remove();
          }

        } catch (error) {
          console.error('Error loading our photos:', error);
          if (!append) {
            slidesContainer.innerHTML =
              '<p>Error loading photos. Please try again.</p>';
          }
        } finally {
          ourPhotosLoading = false;
        }
      }

      function showSlides(n) {
        const slides = document.getElementsByClassName('slide');
        const dots = document.getElementsByClassName('dot');
        const currentTotal = totalPhotos || allPhotos.length; // Use totalPhotos if available, else current length

        if (!slides.length && !ourPhotosLoading) return; // Nothing to show and not loading
        if (currentTotal === 0 && !ourPhotosLoading) return; // No photos loaded and not loading

        // Reset to first slide if we go past the end
        if (n > currentTotal && currentTotal > 0) {
          slideIndex = 1;
        } else if (n < 1 && currentTotal > 0) {
          slideIndex = currentTotal;
        } else {
          slideIndex = n;
        }

        const currentIndex = slideIndex - 1;

        // Load more photos if needed and we're not at the end
        if (
          currentIndex >= allPhotos.length - 2 && // Condition to load when near the end of current batch
          !ourPhotosAllDataLoaded &&
          !ourPhotosLoading
        ) {
          loadOurPhotos(true); // Pass true to append
        }

        // Update slides display
        for (let i = 0; i < slides.length; i++) {
          slides[i].style.display = 'none';
        }

        // Update dots
        for (let i = 0; i < dots.length; i++) {
          dots[i].className = dots[i].className.replace(' active', '');
        }

        // Show current slide and dot
        if (slides[currentIndex]) {
          slides[currentIndex].style.display = 'block';
          if (dots[currentIndex]) {
            dots[currentIndex].className += ' active';
          }
        }

        // Update counter
        const counter = document.querySelector('.photo-counter');
        if (counter && slideIndex <= totalPhotos) {
          counter.textContent = `Photo ${slideIndex} of ${totalPhotos}`;
        }
      }

      function changeSlide(n) {
        showSlides(slideIndex + n);
      }

      function currentSlide(n) {
        showSlides((slideIndex = n));
      }
      
      // let isLoading = false; // Will be replaced by sharedPhotosLoading
      // let hasMore = true; // Will be replaced by !sharedPhotosAllDataLoaded
      // let nextCursor = null; // Will be replaced by sharedPhotosNextCursor

      // Pagination variables for Shared Photos
      let sharedPhotosCurrentPage = 1; // Or use cursor-based as it was
      let sharedPhotosLoading = false;
      let sharedPhotosAllDataLoaded = false;
      let sharedPhotosNextCursor = null;


      async function loadSharedPhotos(append = false) {
        // Use sharedPhotosLoading and sharedPhotosAllDataLoaded
        if (sharedPhotosLoading || (sharedPhotosAllDataLoaded && !append)) return;

        try {
          sharedPhotosLoading = true;
          document.getElementById('loading-spinner').classList.remove('hidden');

          let url = `/get-shared-photos?limit=5`; // Changed limit to 5
          if (append && sharedPhotosNextCursor) { // Use sharedPhotosNextCursor for appending
            url += `&next_cursor=${encodeURIComponent(sharedPhotosNextCursor)}`;
          } else if (!append) {
            // Reset for a fresh load if not appending
            sharedPhotosNextCursor = null; 
            sharedPhotosAllDataLoaded = false;
            document.querySelector('.shared-photos-grid').innerHTML = ''; // Clear previous photos
          }


          const response = await fetch(url);
          if (!response.ok) {
            throw new Error('Failed to fetch shared photos');
          }
          const data = await response.json();

          const gridContainer = document.querySelector('.shared-photos-grid');
          if (!data.photos || data.photos.length === 0) {
            if (!append || gridContainer.innerHTML.trim() === '') { // Check if grid is empty only if not appending or already empty
              gridContainer.innerHTML = '<p>No photos shared yet</p>';
            }
            sharedPhotosAllDataLoaded = true; // All shared photos loaded
            sharedPhotosLoading = false;
            document.getElementById('loading-spinner').classList.add('hidden');
            return;
          }

          const photoHtml = data.photos
            .map(photoUrl => {
              const optimizedUrl = photoUrl.replace(
                '/upload/',
                '/upload/w_400,c_scale,f_auto,q_auto/'
              );
              return `
          <div class="shared-photo loading">
            <img src="${optimizedUrl}" 
              alt="Shared photo" 
              loading="lazy"
              decoding="async"
              onload="this.parentElement.classList.remove('loading')"
              onerror="this.parentElement.classList.add('error')">
          </div>
        `;
            })
            .join('');

          if (append) {
            gridContainer.insertAdjacentHTML('beforeend', photoHtml);
          } else {
            gridContainer.innerHTML = photoHtml;
          }

          // Update pagination state with cursor-based navigation
          sharedPhotosNextCursor = data.next_cursor; // Store new cursor
          if (!data.hasMore || !data.next_cursor) { // If no more or no next_cursor, all data is loaded
            sharedPhotosAllDataLoaded = true;
          }
          
        } catch (error) {
          console.error('Error loading shared photos:', error); // Specific error message
          if (!append) {
            document.querySelector('.shared-photos-grid').innerHTML =
              '<p>Error loading photos. Please try again later.</p>';
          }
          // If an error occurs, consider all data loaded for this attempt to prevent infinite error loops
          sharedPhotosAllDataLoaded = true; 
        } finally {
          sharedPhotosLoading = false; // Reset its own flag
          const spinnerElement = document.getElementById('loading-spinner');
          if (spinnerElement) {
            if (sharedPhotosAllDataLoaded) { // If ALL data is loaded (or an error occurred), hide spinner.
              spinnerElement.classList.add('hidden');
            } else { // If there MIGHT be more data, ensure spinner is visible for the observer.
              spinnerElement.classList.remove('hidden');
            }
          }
        }
      }

      // Initialize intersection observer for infinite scroll
      const observer = new IntersectionObserver(
        entries => {
          entries.forEach(entry => {
            const shareDiv = document.getElementById('share');
            const isShareDivHidden = shareDiv ? shareDiv.classList.contains('hidden') : true;
            const shareSectionActive = shareDiv && !isShareDivHidden;
            
            console.log('[Observer]', {
              isIntersecting: entry.isIntersecting,
              targetId: entry.target.id,
              sharedPhotosAllDataLoaded,
              sharedPhotosLoading,
              // shareSectionActive, // This will be re-evaluated based on direct check
              isShareDivActuallyHidden: isShareDivHidden, // Direct check
              shareDivClassList: shareDiv ? Array.from(shareDiv.classList) : null, // Log the class list
              calculatedShareSectionActive: shareSectionActive, // Log the calculated value
              willLoadMore: entry.isIntersecting && !sharedPhotosAllDataLoaded && !sharedPhotosLoading && shareSectionActive
            });

            if (entry.isIntersecting && !sharedPhotosAllDataLoaded && !sharedPhotosLoading && shareSectionActive) {
              console.log('[Observer] Triggering loadSharedPhotos(true) because all conditions met.');
              loadSharedPhotos(true); // Pass true to append
            } else if (entry.isIntersecting) {
              console.log('[Observer] Spinner is intersecting, but not loading more. Reasons:', {
                allDataLoaded: sharedPhotosAllDataLoaded,
                stillLoading: sharedPhotosLoading,
                shareSectionNotActive: !shareSectionActive,
                isShareDivActuallyHidden_Debug: isShareDivHidden // Add direct check here too for context
              });
            }
          });
        },
        { threshold: 0.1 } // Lowered threshold to 0.1 (10% visibility)
      );

      // Observe the loading spinner
      document.addEventListener('DOMContentLoaded', () => {
        const spinner = document.getElementById('loading-spinner');
        if (spinner) {
          observer.observe(spinner);
        }
      });

      document
        .getElementById('uploadForm')
        .addEventListener('submit', async function (e) {
          e.preventDefault();
          const formData = new FormData(this);
          const statusDiv = document.getElementById('uploadStatus');

          try {
            statusDiv.textContent = 'Uploading...';
            const response = await fetch('/upload-photo', {
              method: 'POST',
              body: formData,
            });

            const result = await response.json();
            if (result.success) {
              statusDiv.textContent = 'Upload successful!';
              this.reset();

              // Add the new photo to the grid immediately
              const gridContainer = document.querySelector(
                '.shared-photos-grid'
              );
              const optimizedUrl = result.url.replace(
                '/upload/',
                '/upload/w_400,f_auto,q_auto/'
              );
              const newPhotoHtml = `
                        <div class="shared-photo loading">
                            <img src="${optimizedUrl}" 
                                alt="Shared photo" 
                                loading="lazy"
                                onload="this.parentElement.classList.remove('loading')">
                        </div>
                    `;

              // Insert at the beginning of the grid
              if (gridContainer.firstChild) {
                gridContainer.insertAdjacentHTML('afterbegin', newPhotoHtml);
              } else {
                gridContainer.innerHTML = newPhotoHtml;
              }
            } else {
              statusDiv.textContent = result.message || 'Upload failed';
            }
          } catch (error) {
            console.error('Error uploading photo:', error);
            statusDiv.textContent = 'Upload failed. Please try again.';
          }
        });

      document
        .getElementById('rsvpForm')
        .addEventListener('submit', async function (e) {
          e.preventDefault();
          const statusDiv = document.getElementById('rsvpStatus');
          const formData = new FormData(this);

          try {
            statusDiv.textContent = 'Sending RSVP...';
            const response = await fetch('/submit-rsvp', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: new URLSearchParams(formData),
            });

            const result = await response.json();
            if (result.success) {
              statusDiv.textContent = 'Thank you! Your RSVP has been sent.';
              this.reset();
            } else {
              statusDiv.textContent = result.message || 'Failed to send RSVP';
            }
          } catch (error) {
            console.error('Error:', error);
            statusDiv.textContent = 'Failed to send RSVP. Please try again.';
          }
        });

      // Contact form submission
      document
        .getElementById('contactForm')
        .addEventListener('submit', async function (e) {
          e.preventDefault();
          const statusDiv = document.getElementById('contactStatus');
          const formData = new FormData(this);

          try {
            statusDiv.textContent = 'Sending message...';
            const response = await fetch('/submit-contact', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: new URLSearchParams(formData),
            });

            const result = await response.json();
            if (result.success) {
              statusDiv.textContent = 'Thank you! Your message has been sent.';
              this.reset();
            } else {
              statusDiv.textContent =
                result.message || 'Failed to send message';
            }
          } catch (error) {
            console.error('Error:', error);
            statusDiv.textContent = 'Failed to send message. Please try again.';
          }
        });

      document
        .getElementById('contactButton')
        .addEventListener('click', function () {
          document.getElementById('contactPopup').classList.add('active');
        });

      document
        .querySelector('.close-popup')
        .addEventListener('click', function () {
          document.getElementById('contactPopup').classList.remove('active');
        });

      function getDirections() {
        const destination = '12.943319832193993,77.68109909325422';
        const mapUrl = `https://www.google.com/maps/dir/?api=1&destination=${destination}`;
        window.open(mapUrl, '_blank');
      }

      // Weather widget script
      async function fetchWeather() {
        const lat = 12.943319;
        const lon = 77.681099;

        // Calculate days until wedding (August 21, 2025)
        const weddingDate = new Date('2025-08-21');
        const today = new Date();
        const daysUntilWedding = Math.ceil(
          (weddingDate - today) / (1000 * 60 * 60 * 24)
        );

        let url;
        if (daysUntilWedding > 7) {
          // Show current weather
          url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=Asia/Kolkata`;
        } else if (daysUntilWedding === 0) {
          // Wedding day is today - use current weather
          url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=Asia/Kolkata`;
        } else {
          // Get forecast for the specific wedding day (within 7 days but not today)
          url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,weathercode,wind_speed_10m_max&timezone=Asia/Kolkata&forecast_days=${daysUntilWedding}`;
        }

        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error('Failed to fetch weather data');
          }
          const data = await response.json();
          console.log(data);
          updateWeatherWidget(data, daysUntilWedding);
        } catch (error) {
          console.error('Error fetching weather:', error);
          document.getElementById('weather-container').innerHTML =
            '<div class="weather-error">Unable to load weather data</div>';
        }
      }

      function getWeatherIcon(weatherCode) {
        // Weather code mapping for Open-Meteo
        const iconMap = {
          0: '☀️', // Clear sky
          1: '🌤️', // Mainly clear
          2: '⛅', // Partly cloudy
          3: '☁️', // Overcast
          45: '🌫️', // Fog
          48: '🌫️', // Depositing rime fog
          51: '🌦️', // Light drizzle
          53: '🌦️', // Moderate drizzle
          55: '🌦️', // Dense drizzle
          61: '🌧️', // Slight rain
          63: '🌧️', // Moderate rain
          65: '🌧️', // Heavy rain
          71: '🌨️', // Slight snow
          73: '🌨️', // Moderate snow
          75: '🌨️', // Heavy snow
          95: '⛈️', // Thunderstorm
          96: '⛈️', // Thunderstorm with hail
          99: '⛈️', // Thunderstorm with heavy hail
        };
        return iconMap[weatherCode] || '🌤️';
      }

      function getWeatherDescription(weatherCode) {
        const descriptions = {
          0: 'Clear sky',
          1: 'Mainly clear',
          2: 'Partly cloudy',
          3: 'Overcast',
          45: 'Foggy',
          48: 'Foggy',
          51: 'Light drizzle',
          53: 'Moderate drizzle',
          55: 'Dense drizzle',
          61: 'Light rain',
          63: 'Moderate rain',
          65: 'Heavy rain',
          71: 'Light snow',
          73: 'Moderate snow',
          75: 'Heavy snow',
          95: 'Thunderstorm',
          96: 'Thunderstorm',
          99: 'Heavy thunderstorm',
        };
        return descriptions[weatherCode] || 'Partly cloudy';
      }

      function updateWeatherWidget(data, daysUntilWedding) {
        const weatherContainer = document.getElementById('weather-container');

        // Handle wedding day is today!
        if (daysUntilWedding === 0) {
          // Update the widget title
          const weatherWidget = weatherContainer.closest('.weather-widget');
          const title = weatherWidget.querySelector('h3');
          title.textContent = 'Weather Today';

          if (data.current_weather) {
            const current = data.current_weather;
            const weatherIcon = getWeatherIcon(current.weathercode);
            const weatherDesc = getWeatherDescription(current.weathercode);

            weatherContainer.innerHTML = `
              <div class="weather-info">
                <div class="weather-main">
                  <span style="font-size: 1.5em; margin-right: 8px;">${weatherIcon}</span>
                  ${weatherDesc}
                </div>
                <div class="weather-temp">${Math.round(current.temperature)}°C</div>
              </div>
              <div class="weather-details">
                <div>💨 Wind: ${Math.round(current.windspeed)} km/h</div>
                <div>🌍 Venue: Vila Kasu</div>
              </div>
              <div style="text-align: center; margin-top: 10px; font-size: 0.9em; color: #d4af37; font-weight: bold;">
                🎉 TODAY IS THE DAY! 🎉<br>
              </div>
            `;
          } else {
            weatherContainer.innerHTML = `
              <div style="text-align: center; padding: 20px; font-size: 1.1em; color: #d4af37; font-weight: bold;">
                🎉 TODAY IS THE WEDDING DAY! 🎉<br>
              </div>
            `;
          }
          return;
        }

        // Handle current weather (when wedding is far away)
        if (data.current_weather && daysUntilWedding > 7) {
          // Update the widget title
          const weatherWidget = weatherContainer.closest('.weather-widget');
          const title = weatherWidget.querySelector('h3');
          title.textContent = 'Current Weather';

          const current = data.current_weather;
          const weatherIcon = getWeatherIcon(current.weathercode);
          const weatherDesc = getWeatherDescription(current.weathercode);

          const forecastAvailableIn = daysUntilWedding - 7;

          weatherContainer.innerHTML = `
            <div class="weather-info">
              <div class="weather-main">
                <span style="font-size: 1.5em; margin-right: 8px;">${weatherIcon}</span>
                ${weatherDesc}
              </div>
              <div class="weather-temp">${Math.round(current.temperature)}°C</div>
            </div>
            <div class="weather-details">
              <div>💨 Wind: ${Math.round(current.windspeed)} km/h</div>
              <div>🌍 Venue: Vila Kasu</div>
            </div>
            <div style="text-align: center; margin-top: 10px; font-size: 0.8em; opacity: 0.8;">
              Today's weather in Bengaluru ☀️<br>Wedding forecast available in ${forecastAvailableIn} days! ✨
            </div>
          `;
          return;
        }

        // Handle wedding day forecast (when within 7 days)
        const daily = data.daily;
        if (
          !daily ||
          !daily.temperature_2m_max ||
          daily.temperature_2m_max.length === 0
        ) {
          weatherContainer.innerHTML =
            '<div class="weather-error">Wedding day forecast not available yet</div>';
          return;
        }

        // Update the widget title for forecast
        const weatherWidget = weatherContainer.closest('.weather-widget');
        const title = weatherWidget.querySelector('h3');
        title.textContent = 'Wedding Day Forecast';

        // Get the wedding day data (daysUntilWedding - 1 since array is 0-indexed)
        const weddingDayIndex = daysUntilWedding - 1;

        const weatherCode = daily.weathercode[weddingDayIndex];
        const maxTemp = daily.temperature_2m_max[weddingDayIndex];
        const minTemp = daily.temperature_2m_min[weddingDayIndex];
        const humidity = daily.relative_humidity_2m
          ? daily.relative_humidity_2m[weddingDayIndex]
          : null;
        const windSpeed = daily.wind_speed_10m_max[weddingDayIndex];

        const weatherIcon = getWeatherIcon(weatherCode);
        const weatherDesc = getWeatherDescription(weatherCode);

        weatherContainer.innerHTML = `
          <div class="weather-info">
            <div class="weather-main">
              <span style="font-size: 1.5em; margin-right: 8px;">${weatherIcon}</span>
              ${weatherDesc}
            </div>
            <div class="weather-temp">${Math.round((maxTemp + minTemp) / 2)}°C</div>
          </div>
          <div class="weather-details">
            <div>🌡️ High: ${Math.round(maxTemp)}°C</div>
            <div>🌡️ Low: ${Math.round(minTemp)}°C</div>
            ${humidity ? `<div>💧 Humidity: ${humidity}%</div>` : ''}
            <div>💨 Wind: ${Math.round(windSpeed)} km/h</div>
          </div>
          <div style="text-align: center; margin-top: 10px; font-size: 0.8em; opacity: 0.8;">
            Wedding day forecast (Aug 21, 2025) ✨<br>
          </div>
        `;
      }

      // Initialize weather widget
      document.addEventListener('DOMContentLoaded', function () {
        // Load weather when page loads
        fetchWeather();

        // Refresh weather every 30 minutes
        setInterval(fetchWeather, 30 * 60 * 1000);
      });

      // Simple copy function
      function copyHashtag() {
        const hashtag = '#athirawedsgowtham2025';
        const button = event.target;

        // Try to copy
        if (navigator.clipboard) {
          navigator.clipboard
            .writeText(hashtag)
            .then(() => {
              button.textContent = 'Copied!';
              button.classList.add('copied');
              setTimeout(() => {
                button.textContent = 'Copy';
                button.classList.remove('copied');
              }, 2000);
            })
            .catch(() => {
              // Fallback
              const textarea = document.createElement('textarea');
              textarea.value = hashtag;
              document.body.appendChild(textarea);
              textarea.select();
              document.execCommand('copy');
              document.body.removeChild(textarea);
              button.textContent = 'Copied!';
              button.classList.add('copied');
              setTimeout(() => {
                button.textContent = 'Copy';
                button.classList.remove('copied');
              }, 2000);
            });
        } else {
          // Old browser fallback
          const textarea = document.createElement('textarea');
          textarea.value = hashtag;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          button.textContent = 'Copied!';
          button.classList.add('copied');
          setTimeout(() => {
            button.textContent = 'Copy';
            button.classList.remove('copied');
          }, 2000);
        }
      }

      // Lightbox functionality for shared photos
      document.addEventListener('DOMContentLoaded', function() {
        const lightbox = document.getElementById('photoLightbox');
        const lightboxImg = document.getElementById('lightboxImage');
        const lightboxClose = document.querySelector('.lightbox-close');
        
        // Make shared photos clickable
        document.querySelector('.shared-photos-grid').addEventListener('click', function(e) {
          // Find the clicked element - either the image or its container
          const clickedPhoto = e.target.closest('.shared-photo');
          if (clickedPhoto) {
            e.preventDefault();
            const img = clickedPhoto.querySelector('img');
            if (img) {
              console.log('Opening lightbox for:', img.src);
              
              // Get full resolution image URL (remove Cloudinary transformations)
              let fullUrl = img.src.replace('/upload/w_400,c_scale,f_auto/', '/upload/');
              
              // Set image and show lightbox
              lightboxImg.src = fullUrl;
              lightbox.classList.add('active');
            }
          }
        });
        
        // Close lightbox when clicking the close button
        lightboxClose.addEventListener('click', function() {
          lightbox.classList.remove('active');
        });
        
        // Close lightbox when clicking outside the image
        lightbox.addEventListener('click', function(e) {
          if (e.target === lightbox) {
            lightbox.classList.remove('active');
          }
        });
        
        // Close lightbox with Escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && lightbox.classList.contains('active')) {
            lightbox.classList.remove('active');
          }
        });
      });

      // Add to Calendar functionality
      function toggleCalendarOptions() {
        const calendarOptions = document.getElementById('calendarOptions');
        if (calendarOptions) {
          calendarOptions.classList.toggle('active');
        }
      }

      function addToCalendar(type) {
        const weddingDate = new Date('2025-08-21T10:00:00');
        const endDate = new Date('2025-08-21T18:00:00');
        const formattedStartDate = weddingDate.toISOString().replace(/-|:|\.\d{3}/g, '');
        const formattedEndDate = endDate.toISOString().replace(/-|:|\.\d{3}/g, '');
        
        // Enhanced event details
        const eventTitle = 'Athira & Gowtham\'s Wedding';
        const location = 'Vila Kasu, 1, Kariyammana Agrahara Rd, Yemalur, Bengaluru 560037, Karnataka, India';
        const description = 'You are cordially invited to celebrate our wedding on August 21, 2025 in Bengaluru. Join us for a day of love, laughter, and celebration!\\n\\nWebsite: https://athiraandgowtham.onrender.com\\nVenue: Vila Kasu\\nTime: 10:00 AM - 6:00 PM IST\\nDress Code: Traditional Indian Attire\\n\\nFor directions: https://maps.google.com/?q=12.943319832193993,77.68109909325422';
        
        const calendarUrl = {
          google: `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(eventTitle)}&dates=${formattedStartDate}/${formattedEndDate}&details=${encodeURIComponent(description)}&location=${encodeURIComponent(location)}&sf=true&output=xml`,
          apple: `/wedding-invitation.ics`,
          outlook: `https://outlook.live.com/calendar/0/deeplink/compose?subject=${encodeURIComponent(eventTitle)}&startdt=${formattedStartDate}&enddt=${formattedEndDate}&body=${encodeURIComponent(description)}&location=${encodeURIComponent(location)}&path=/calendar/action/compose&rru=addevent`,
          yahoo: `https://calendar.yahoo.com/?v=60&view=d&type=20&title=${encodeURIComponent(eventTitle)}&st=${formattedStartDate}&et=${formattedEndDate}&desc=${encodeURIComponent(description)}&in_loc=${encodeURIComponent(location)}`,
          ics: `/wedding-invitation.ics`,
        };

        if (calendarUrl[type]) {
          window.open(calendarUrl[type], '_blank');
        }
      }
      
      document.addEventListener('DOMContentLoaded', function() {
        // Hide calendar options when clicking outside
        document.addEventListener('click', function(e) {
          if (!e.target.closest('.add-to-calendar-wrapper')) {
            const calendarOptions = document.getElementById('calendarOptions');
            if (calendarOptions) {
              calendarOptions.classList.remove('active');
            }
          }
        });
        
        // Calendar option click handler
        document.addEventListener('click', function(e) {
          if (e.target.classList.contains('calendar-option')) {
            e.preventDefault();
            const calendarType = e.target.getAttribute('data-calendar');
            addToCalendar(calendarType);
          }
        });
        
        // ...existing code...
      });
    </script>
    <!-- Initialize Eruda (conditionally) -->
    <script>
      if (new URLSearchParams(window.location.search).has('debug')) {
        eruda.init();
      }
    </script>
  </body>
</html>
